<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OpenSwoole WebSocket Client with Sanctum Auth</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; }
        .messages { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; margin: 10px 0; background: #f9f9f9; }
        .controls { margin: 10px 0; }
        input, button { padding: 8px; margin: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .auth-section { background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .user-info { background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0; }
        #tokenInput { width: 400px; }
    </style>
</head>
<body>
<div class="container">
    <h1>OpenSwoole WebSocket Client (Sanctum Auth)</h1>

    <div class="auth-section">
        <h3>üîê Authentication</h3>
        <div>
            <label>Sanctum Token:</label><br>
            <input type="text" id="tokenInput" placeholder="Paste your Sanctum token here..."
                   value="">
            <button onclick="generateTestToken()">Generate Test Token</button>
        </div>
        <div id="userInfo" class="user-info" style="display: none;">
            <strong>User:</strong> <span id="userName"></span> (<span id="userId"></span>)
        </div>
    </div>

    <div id="status" class="status disconnected">Disconnected</div>

    <div class="controls">
        <button id="connectBtn">Connect with Token</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
        <button id="pingBtn" disabled>Send Ping</button>
    </div>

    <div class="controls">
        <input type="text" id="roomInput" placeholder="Room ID (e.g. socket.chats.1.13)" value="socket.chats.1">
        <button id="joinRoomBtn" disabled>Join Room</button>
        <button id="leaveRoomBtn" disabled>Leave Room</button>
    </div>

    <div class="controls">
        <input type="text" id="messageInput" placeholder="Type a message..." style="width: 300px;">
        <button id="sendBtn" disabled>Send Message</button>
    </div>

    <div id="messages" class="messages"></div>
</div>

<script>
let ws = null;
let isConnected = false;
let currentUser = null;

const statusEl = document.getElementById('status');
const messagesEl = document.getElementById('messages');
const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const pingBtn = document.getElementById('pingBtn');
const joinRoomBtn = document.getElementById('joinRoomBtn');
const leaveRoomBtn = document.getElementById('leaveRoomBtn');
const sendBtn = document.getElementById('sendBtn');
const roomInput = document.getElementById('roomInput');
const messageInput = document.getElementById('messageInput');
const tokenInput = document.getElementById('tokenInput');
const userInfo = document.getElementById('userInfo');
const userName = document.getElementById('userName');
const userId = document.getElementById('userId');

function addMessage(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const div = document.createElement('div');
    div.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
    div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

function updateStatus(connected) {
    isConnected = connected;
    statusEl.textContent = connected ? 'Connected & Authenticated' : 'Disconnected';
    statusEl.className = `status ${connected ? 'connected' : 'disconnected'}`;

    // Update button states
    connectBtn.disabled = connected;
    disconnectBtn.disabled = !connected;
    pingBtn.disabled = !connected;
    joinRoomBtn.disabled = !connected;
    leaveRoomBtn.disabled = !connected;
    sendBtn.disabled = !connected;
}

function connect() {
    const token = tokenInput.value.trim();
    if (!token) {
        addMessage('‚ùå Please enter your Sanctum token first!', 'error');
        return;
    }

    if (ws) {
        ws.close();
    }

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ OpenSwoole WebSocket —Å–µ—Ä–≤–µ—Ä—É —Å —Ç–æ–∫–µ–Ω–æ–º –≤ query
    const wsUrl = `ws://localhost:8082?token=${encodeURIComponent(token)}`;

    addMessage(`üîå Connecting to: ${wsUrl}`, 'info');
    ws = new WebSocket(wsUrl);

    ws.onopen = function(event) {
        addMessage('‚úÖ Connected to OpenSwoole WebSocket server', 'success');
        // –ñ–¥–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ welcome –∏–ª–∏ auth_failed
    };

    ws.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            addMessage(`üì© Received: ${JSON.stringify(data, null, 2)}`);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
            switch(data.event_name) {
                case 'welcome':
                    addMessage(`üéâ ${data.message}`, 'success');
                    if (data.user) {
                        currentUser = data.user;
                        userName.textContent = data.user.name || data.user.email || 'Unknown';
                        userId.textContent = data.user.id;
                        userInfo.style.display = 'block';
                        updateStatus(true);
                    }
                    break;

                case 'auth_required':
                    addMessage(`üîê ${data.error}`, 'warning');
                    addMessage('Please enter a valid Sanctum token and try again.', 'warning');
                    break;

                case 'auth_failed':
                    addMessage(`‚ùå Authentication failed: ${data.error}`, 'error');
                    updateStatus(false);
                    break;

                case 'pong':
                    addMessage('üèì Pong received', 'success');
                    break;

                case 'room_joined':
                    addMessage(`üè† Successfully joined room: ${data.room}`, 'success');
                    if (data.room_stats) {
                        addMessage(`üìä Room stats: ${data.room_stats.total_users} users online`, 'info');
                        if (data.room_stats.online_users.length > 0) {
                            const users = data.room_stats.online_users.map(u => u.name || `User ${u.id}`).join(', ');
                            addMessage(`üë• Online users: ${users}`, 'info');
                        }
                    }
                    break;

                case 'join_room_failed':
                    addMessage(`‚ùå Failed to join room: ${data.error}`, 'error');
                    break;

                case 'room_left':
                    addMessage(`üö™ Left room: ${data.room}`, 'success');
                    break;

                case 'user_joined_room':
                    addMessage(`üëã ${data.user.name || `User ${data.user.id}`} joined room: ${data.room}`, 'info');
                    break;

                case 'user_left_room':
                    addMessage(`üëã ${data.user.name || `User ${data.user.id}`} left room: ${data.room}`, 'info');
                    break;

                case 'timeout_warning':
                    addMessage(`‚ö†Ô∏è ${data.message}`, 'warning');
                    break;

                default:
                    addMessage(`üì© Unknown event: ${data.event_name}`, 'warning');
            }
        } catch (e) {
            addMessage(`üì© Raw message: ${event.data}`);
        }
    };

    ws.onclose = function(event) {
        addMessage('‚ùå Connection closed', 'error');
        updateStatus(false);
        currentUser = null;
        userInfo.style.display = 'none';
    };

    ws.onerror = function(error) {
        addMessage(`‚ùå WebSocket error: ${error}`, 'error');
        updateStatus(false);
    };
}

function disconnect() {
    if (ws) {
        ws.close();
    }
}

function sendPing() {
    if (ws && isConnected) {
        const message = {
            event_name: 'ping'
        };
        ws.send(JSON.stringify(message));
        addMessage(`üì§ Sent ping`);
    }
}

function joinRoom() {
    const roomId = roomInput.value.trim();
    if (ws && isConnected && roomId) {
        const message = {
            event_name: 'join_room',
            room: roomId
        };
        ws.send(JSON.stringify(message));
        addMessage(`üì§ Joining room: ${roomId}`);
    }
}

function leaveRoom() {
    const roomId = roomInput.value.trim();
    if (ws && isConnected && roomId) {
        const message = {
            event_name: 'leave_room',
            room: roomId
        };
        ws.send(JSON.stringify(message));
        addMessage(`üì§ Leaving room: ${roomId}`);
    }
}

function sendMessage() {
    const message = messageInput.value.trim();
    const roomId = roomInput.value.trim();

    if (ws && isConnected && message) {
        const data = {
            event_name: 'message',
            message: message,
            room: roomId || 'general'
        };
        ws.send(JSON.stringify(data));
        addMessage(`üì§ Sent message: "${message}" to room: ${roomId || 'general'}`);
        messageInput.value = '';
    }
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
async function generateTestToken() {
    try {
        addMessage('üîÑ Generating test token...', 'info');

        // –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –≤–∞—à–µ–º—É API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
        // –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                email: 'test@example.com', // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                password: 'password'
            })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.token) {
                tokenInput.value = data.token;
                addMessage('‚úÖ Test token generated successfully!', 'success');
            } else {
                addMessage('‚ùå No token in response', 'error');
            }
        } else {
            addMessage('‚ùå Failed to generate token. Using mock token for demo.', 'warning');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–∫–æ–≤—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            tokenInput.value = 'demo_token_replace_with_real';
        }
    } catch (error) {
        addMessage('‚ùå Error generating token. Please enter manually.', 'error');
        console.error('Token generation error:', error);
    }
}

// Event listeners
connectBtn.addEventListener('click', connect);
disconnectBtn.addEventListener('click', disconnect);
pingBtn.addEventListener('click', sendPing);
joinRoomBtn.addEventListener('click', joinRoom);
leaveRoomBtn.addEventListener('click', leaveRoom);
sendBtn.addEventListener('click', sendMessage);

// Enter key for message input
messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Enter key for token input
tokenInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        connect();
    }
});

// –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
addMessage('üëã Welcome! To connect:', 'info');
addMessage('1. Get your Sanctum token from Laravel app', 'info');
addMessage('2. Paste it in the token field above', 'info');
addMessage('3. Click "Connect with Token"', 'info');
addMessage('4. Try joining room: socket.chats.1', 'info');
</script>
</body>
</html>